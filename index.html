<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <base target="_self">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neide Variedades - Sistema Dark</title>
    
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: { 
                        primary: "#a855f7",    /* Roxo Neon Mais Claro */
                        secondary: "#c084fc",  /* Lil√°s Brilhante */
                        dark: "#0f172a",       /* Fundo Principal (Slate 900) */
                        surface: "#1e293b",    /* Cart√µes (Slate 800) */
                        input: "#334155"       /* Inputs (Slate 700) */
                    },
                    fontFamily: {
                        'title': ['"Dancing Script"', 'cursive'],
                        'body': ['"Quicksand"', 'sans-serif']
                    }
                } 
            }
        }
    </script>

    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #0f172a; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn { transition: all 0.3s; opacity: 0.5; color: #94a3b8; }
        .nav-btn.active { opacity: 1; transform: scale(1.1); color: #a855f7; border-bottom: 3px solid #a855f7; }
        .status-pago { border-left: 6px solid #22c55e !important; background: linear-gradient(to right, rgba(34, 197, 94, 0.1), #1e293b); }
        .status-parcial { border-left: 6px solid #f59e0b !important; background: linear-gradient(to right, rgba(245, 158, 11, 0.1), #1e293b); }
        .status-pendente { border-left: 6px solid #ef4444 !important; background: linear-gradient(to right, rgba(239, 68, 68, 0.1), #1e293b); }
        .filt-btn { transition: all 0.2s; }
        .filt-btn.active { background-color: #a855f7; color: white; border-color: #a855f7; }
        @media print { 
             .no-print { display: none !important; } 
             .print-only { display: block !important; } 
             #modal-nota { position: absolute !important; inset: 0 !important; background: white !important; padding: 0 !important; display: block !important; z-index: 9999; }
             body { background: white; color: black; }
             .bg-surface { background: white !important; color: black !important; border: 1px solid #ccc; }
             .text-white { color: black !important; }
        }
        .print-only { display: none; }
        #modal-nota, #modal-pagamento { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
    </style>
</head>
<body class="pb-24 select-none">

    <audio id="som-venda" src="https://www.myinstants.com/media/sounds/cash-register-ka-ching.mp3" preload="auto"></audio>

    <div id="loading" class="hidden fixed inset-0 bg-dark/95 z-[1100] flex flex-col items-center justify-center text-primary font-bold">
        <div class="animate-bounce text-4xl mb-4"><i class="fas fa-shopping-bag"></i></div>
        <span class="uppercase tracking-widest text-sm text-white">Carregando Sistema...</span>
    </div>

    <header class="bg-surface p-4 shadow-lg flex justify-between items-center no-print sticky top-0 z-40 border-b border-gray-700">
        <div class="flex items-center gap-3">
            <div class="bg-gray-700 text-primary w-10 h-10 rounded-full flex items-center justify-center shadow-lg">
                <i class="fas fa-shopping-bag text-lg"></i>
            </div>
            <div>
                <h1 class="text-3xl font-title text-white leading-none">Neide Variedades</h1>
                <p class="text-[10px] uppercase font-bold text-gray-400 tracking-widest ml-1">Sistema Inteligente</p>
            </div>
        </div>
        <button onclick="carregarDados()" class="text-primary bg-gray-700 p-3 rounded-full hover:bg-gray-600 transition shadow-lg border border-gray-600">
            <i class="fas fa-sync-alt animate-pulse"></i>
        </button>
    </header>

    <nav class="fixed bottom-0 left-0 right-0 bg-surface shadow-[0_-4px_15px_rgba(0,0,0,0.5)] flex justify-around p-3 z-50 no-print rounded-t-3xl border-t border-gray-700">
        <button onclick="switchTab('sales')" id="btn-sales" class="nav-btn active flex flex-col items-center gap-1 text-xs font-bold uppercase">
            <i class="fas fa-cash-register text-xl"></i> Vender
        </button>
        <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-btn flex flex-col items-center gap-1 text-xs font-bold uppercase">
            <i class="fas fa-chart-pie text-xl"></i> Caixa
        </button>
        <button onclick="switchTab('clients')" id="btn-clients" class="nav-btn flex flex-col items-center gap-1 text-xs font-bold uppercase">
            <i class="fas fa-address-book text-xl"></i> Cobran√ßa
        </button>
        <button onclick="switchTab('products')" id="btn-products" class="nav-btn flex flex-col items-center gap-1 text-xs font-bold uppercase">
            <i class="fas fa-boxes text-xl"></i> Produtos
        </button>
    </nav>

    <main class="container mx-auto p-4 max-w-xl no-print">
        <div id="status-msg" class="text-center p-2 mb-4 text-xs font-bold uppercase rounded-xl hidden shadow-sm"></div>

        <section id="sales" class="tab-content active space-y-4">
            <div class="bg-surface p-5 rounded-3xl shadow-lg border border-gray-700 space-y-3">
                <div class="flex items-center gap-2 mb-2 text-primary border-b border-gray-700 pb-2">
                    <i class="fas fa-user-circle"></i> <span class="font-bold text-sm uppercase">Cliente</span>
                </div>
                <input type="text" id="v-cliente" placeholder="NOME DO CLIENTE" class="w-full p-3 bg-input rounded-xl outline-none focus:ring-2 focus:ring-primary/50 font-bold uppercase text-white text-sm border border-gray-600 placeholder-gray-500">
                <div class="grid grid-cols-2 gap-3">
                    <input type="tel" id="v-tel" placeholder="WhatsApp" class="p-3 bg-input rounded-xl outline-none text-sm font-semibold text-white border border-gray-600 placeholder-gray-500">
                    <input type="date" id="v-data" class="p-3 bg-input rounded-xl outline-none text-sm font-semibold text-gray-300 border border-gray-600">
                </div>
                <input type="text" id="v-cpf" placeholder="CPF (Opcional)" class="w-full p-3 bg-input rounded-xl outline-none text-sm font-semibold text-white border border-gray-600 placeholder-gray-500">
            </div>

            <div class="bg-surface p-5 rounded-3xl shadow-lg border border-gray-700">
                <div class="flex items-center gap-2 mb-3 text-primary">
                    <i class="fas fa-search"></i> <span class="font-bold text-sm uppercase">Adicionar Produtos</span>
                </div>
                <input type="text" oninput="renderGradeProdutos(this.value)" placeholder="Buscar produto..." class="w-full p-3 mb-4 bg-input rounded-xl border border-gray-600 outline-none font-bold text-sm uppercase text-white placeholder-gray-500">
                <div id="grid-produtos" class="grid grid-cols-2 gap-2 max-h-56 overflow-y-auto pr-1"></div>
            </div>

            <div class="bg-surface rounded-3xl shadow-lg overflow-hidden border border-gray-700">
                <div class="bg-gray-800 p-4 flex justify-between items-center text-xs font-bold uppercase text-primary border-b border-gray-700">
                    <span><i class="fas fa-shopping-basket mr-1"></i> Carrinho</span>
                    <span id="itens-count" class="bg-gray-700 text-white px-2 py-1 rounded-lg shadow-sm border border-gray-600">0 itens</span>
                </div>
                <div id="lista-pedido" class="divide-y divide-gray-700 max-h-48 overflow-y-auto">
                    <div class="p-8 text-center text-gray-500 text-sm italic">Sua sacola est√° vazia üõçÔ∏è</div>
                </div>
                
                <div class="p-5 bg-surface border-t border-dashed border-gray-600">
                    <div class="flex justify-between items-end mb-4">
                        <span class="text-xs font-bold text-gray-400 uppercase">Total Final</span>
                        <span id="res-venda" class="text-3xl font-bold text-primary font-title">R$ 0,00</span>
                    </div>
                    
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Forma de Pagamento</label>
                    <div class="relative">
                        <select id="v-pgto" class="w-full p-4 mt-1 bg-input rounded-2xl font-bold text-white outline-none appearance-none border border-gray-600 focus:border-primary cursor-pointer">
                            <option value="DINHEIRO">üíµ Dinheiro</option>
                            <option value="PIX">üí† PIX</option>
                            <option value="CART√ÉO">üí≥ Cart√£o</option>
                            <option value="A PRAZO">üì¶ Fiado / Parcelado</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-5 text-gray-400 pointer-events-none"></i>
                    </div>

                    <div id="box-entrada" class="hidden mt-3 animate-[fadeIn_0.3s]">
                        <label class="text-[10px] font-bold text-primary uppercase ml-1">Valor de Entrada (R$)</label>
                        <input type="number" id="v-entrada" value="0.00" class="w-full p-3 rounded-xl bg-gray-800 border-2 border-primary text-lg font-bold text-white outline-none">
                        <p class="text-[10px] text-gray-500 mt-1 ml-1">* Se n√£o houver entrada, deixe 0.00</p>
                    </div>

                    <button onclick="registrarVenda()" class="w-full mt-4 bg-gradient-to-r from-primary to-purple-900 text-white font-bold rounded-2xl p-4 uppercase text-sm shadow-lg shadow-purple-900/50 active:scale-95 transition-all flex justify-center items-center gap-2 border border-purple-500/30">
                        <span>Finalizar Venda</span> <i class="fas fa-check-circle"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="dashboard" class="tab-content space-y-4">
            <div class="text-center mb-2">
                <h2 class="font-title text-3xl text-white">Resumo Financeiro</h2>
                <p class="text-xs text-gray-400 uppercase font-bold">Balan√ßo Geral</p>
            </div>

            <div class="bg-surface p-3 rounded-2xl border border-gray-700 space-y-3">
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                    <button onclick="setFiltroDash(0, this)" class="filt-btn active flex-1 py-2 px-3 rounded-xl bg-input text-gray-300 text-[10px] font-bold uppercase border border-gray-600">Hoje</button>
                    <button onclick="setFiltroDash(7, this)" class="filt-btn flex-1 py-2 px-3 rounded-xl bg-input text-gray-300 text-[10px] font-bold uppercase border border-gray-600">7 Dias</button>
                    <button onclick="setFiltroDash(30, this)" class="filt-btn flex-1 py-2 px-3 rounded-xl bg-input text-gray-300 text-[10px] font-bold uppercase border border-gray-600">30 Dias</button>
                    <button onclick="setFiltroDash(90, this)" class="filt-btn flex-1 py-2 px-3 rounded-xl bg-input text-gray-300 text-[10px] font-bold uppercase border border-gray-600">90 Dias</button>
                    <button onclick="setFiltroDash('all', this)" class="filt-btn flex-1 py-2 px-3 rounded-xl bg-input text-gray-300 text-[10px] font-bold uppercase border border-gray-600">Tudo</button>
                </div>
                <div class="relative">
                    <i class="fas fa-filter absolute left-3 top-3 text-gray-500 text-xs"></i>
                    <input type="text" id="filtro-prod-dash" oninput="renderDash()" placeholder="Filtrar por produto espec√≠fico..." class="w-full p-2 pl-8 bg-gray-900 rounded-lg text-xs font-bold text-white border border-gray-700 outline-none uppercase">
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <div class="bg-surface p-4 rounded-2xl shadow-sm border-l-4 border-primary flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Faturamento</p>
                        <p id="dash-faturam" class="text-2xl font-bold text-white">R$ 0,00</p>
                    </div>
                    <div class="bg-gray-700 text-primary p-3 rounded-full"><i class="fas fa-coins"></i></div>
                </div>

                <div class="bg-surface p-4 rounded-2xl shadow-sm border-l-4 border-red-500 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Custo dos Produtos</p>
                        <p id="dash-custo" class="text-2xl font-bold text-red-400">R$ 0,00</p>
                    </div>
                    <div class="bg-gray-700 text-red-400 p-3 rounded-full"><i class="fas fa-tags"></i></div>
                </div>

                <div class="bg-gradient-to-r from-primary to-purple-900 p-5 rounded-2xl shadow-lg text-white flex justify-between items-center border border-purple-700">
                    <div>
                        <p class="text-[10px] font-bold text-purple-200 uppercase">Lucro L√≠quido</p>
                        <p id="dash-lucro" class="text-3xl font-bold">R$ 0,00</p>
                    </div>
                    <div class="bg-white/10 p-3 rounded-full backdrop-blur-sm"><i class="fas fa-trophy"></i></div>
                </div>
            </div>

            <div class="bg-surface rounded-3xl shadow-sm p-4 border border-gray-700">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-1">Vendas no Per√≠odo (Ordenadas)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-[10px] uppercase text-gray-500 border-b border-dashed border-gray-600">
                            <tr><th class="pb-2 pl-2">Data</th><th class="pb-2">Cliente/Prod</th><th class="pb-2 text-right pr-2">Total</th></tr>
                        </thead>
                        <tbody id="dash-saidas" class="text-gray-300 font-bold"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="clients" class="tab-content space-y-4">
            <div class="sticky top-0 bg-dark pt-2 pb-2 z-10">
                <div class="relative shadow-sm rounded-2xl">
                    <i class="fas fa-search absolute left-4 top-3.5 text-primary"></i>
                    <input type="text" id="busca-venda" oninput="filtrarVendas()" placeholder="Buscar cliente ou ID..." class="w-full p-3 pl-10 rounded-2xl outline-none font-bold uppercase text-white text-sm border border-gray-600 focus:border-primary bg-surface placeholder-gray-500">
                </div>
            </div>

            <div id="lista-vendas-container" class="space-y-3 pb-20"></div>
        </section>

        <section id="products" class="tab-content space-y-4">
            <div class="bg-surface p-5 rounded-3xl shadow-lg border border-gray-700 space-y-3">
                <div class="flex items-center gap-2 mb-2 text-primary">
                    <i class="fas fa-plus-circle"></i> <span class="font-bold text-sm uppercase">Novo Produto</span>
                </div>
                <input type="text" id="p-nome" placeholder="NOME DO PRODUTO" class="w-full p-3 bg-input rounded-xl outline-none font-bold uppercase text-white text-sm border border-gray-600 placeholder-gray-500">
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-xs text-gray-400">Custo</span>
                        <input type="number" id="p-custo" placeholder="0.00" class="w-full p-3 pt-6 bg-gray-900 rounded-xl outline-none font-bold text-red-400 text-sm border border-gray-700">
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-xs text-gray-400">Venda</span>
                        <input type="number" id="p-venda" placeholder="0.00" class="w-full p-3 pt-6 bg-gray-900 rounded-xl outline-none font-bold text-green-400 text-sm border border-gray-700">
                    </div>
                </div>
                <button onclick="adicionarProduto()" class="w-full bg-secondary text-dark font-bold p-3 rounded-xl uppercase text-xs shadow-sm hover:bg-primary hover:text-white transition">Salvar Produto</button>
            </div>
            
            <div id="lista-produtos-cards" class="space-y-2 pb-20"></div>
        </section>
    </main>

    <div id="modal-nota" class="no-print" onclick="if(event.target == this) fecharNota()">
        <div class="bg-white w-full max-w-sm overflow-hidden shadow-2xl rounded-3xl animate-[fadeIn_0.3s] text-black">
            <div class="bg-gray-900 p-4 text-center text-white relative overflow-hidden">
                <div class="absolute -top-4 -left-4 w-16 h-16 bg-white/10 rounded-full"></div>
                <div class="absolute top-2 right-2 w-8 h-8 bg-white/10 rounded-full"></div>
                <h2 class="font-title text-3xl">Neide Variedades</h2>
                <p class="text-[10px] uppercase tracking-widest opacity-80">Comprovante de Venda</p>
            </div>
            
            <div id="area-recibo-cliente" class="p-6 text-gray-800 font-mono text-xs leading-relaxed bg-white relative">
                <div class="flex justify-between border-b border-dashed border-black pb-2 mb-2">
                    <span>DATA: <b id="p-data"></b></span>
                    <span>ID: <b id="recibo-id"></b></span>
                </div>
                
                <div class="mb-4 space-y-1">
                    <p>CLIENTE: <b id="p-cliente" class="uppercase"></b></p>
                    <p id="box-tel-nota" class="hidden">TEL: <span id="p-tel-nota"></span></p>
                    <p id="box-cpf-nota" class="hidden">CPF: <span id="p-cpf-nota"></span></p>
                </div>

                <div class="bg-gray-100 p-2 rounded mb-2 border border-gray-300">
                    <div id="p-itens" class="space-y-1"></div>
                </div>

                <div class="flex justify-between text-base font-bold text-black mt-2 border-t pt-2 border-black">
                    <span>TOTAL:</span> <span id="p-total-venda">R$ 0,00</span>
                </div>

                <div class="mt-3 space-y-1 text-[11px]">
                    <div class="flex justify-between">
                        <span>Valor Pago:</span> <span id="p-valor-pago" class="font-bold">R$ 0,00</span>
                    </div>
                    <div id="linha-restante" class="flex justify-between text-red-600 font-bold hidden bg-red-50 p-1 rounded">
                        <span>RESTANTE A PAGAR:</span> <span id="p-valor-restante">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between text-gray-500 mt-2">
                        <span>Forma Pgto:</span> <span id="p-pgto-nota"></span>
                    </div>
                    <div class="text-center mt-2 font-bold uppercase border border-black rounded p-1">
                        Status: <span id="p-status"></span>
                    </div>
                </div>
                
                <p class="text-center text-[10px] mt-4 font-title text-black text-lg">Obrigada e volte sempre!</p>
            </div>

            <div class="p-4 bg-gray-100 flex gap-2">
                <button onclick="enviarZap()" class="flex-1 bg-green-600 text-white p-3 rounded-xl text-xs font-bold uppercase shadow active:scale-95 transition"><i class="fab fa-whatsapp text-base"></i> Enviar</button>
                <button onclick="window.print()" class="flex-1 bg-gray-800 text-white p-3 rounded-xl text-xs font-bold uppercase shadow active:scale-95 transition"><i class="fas fa-print"></i> Imprimir</button>
                <button onclick="fecharNota()" class="bg-white text-gray-600 border p-3 rounded-xl shadow-sm"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>

    <div id="modal-pagamento" class="no-print">
        <div class="bg-surface rounded-[2rem] p-6 w-full max-w-xs shadow-2xl text-center relative overflow-hidden border border-gray-700">
            <div class="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-primary to-secondary"></div>
            <div class="w-16 h-16 bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-green-400 text-2xl border border-green-500/30">
                <i class="fas fa-hand-holding-usd"></i>
            </div>
            <h3 class="text-lg font-bold text-white mb-1">Receber Pagamento</h3>
            <p class="text-xs text-gray-400 mb-4">Abater d√≠vida da cliente</p>
            <input type="number" id="valor-abatimento" class="w-full p-4 text-3xl font-bold text-center bg-dark rounded-xl text-white outline-none mb-4 focus:ring-2 focus:ring-green-500 border border-gray-600" placeholder="0.00">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="fecharModalPagamento()" class="p-3 rounded-xl font-bold text-gray-400 bg-gray-800 hover:bg-gray-700">Cancelar</button>
                <button onclick="confirmarAbatimento()" class="p-3 rounded-xl font-bold text-white bg-green-600 shadow-lg shadow-green-900/50 hover:bg-green-500">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbz64ikmr4PnvPoaWUdzlP-dmVRbUidEWlSpEGBgrKBBEWCEEKbHRiYItmmlT09Jx4Rz4A/exec"; 
        
        let DB = { produtos: [], vendas: [] };
        let pedido = [];
        let filtroDashDias = 0;
        let vParaAbater = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('v-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('v-pgto').addEventListener('change', function() {
                const box = document.getElementById('box-entrada');
                if(this.value === 'A PRAZO') {
                    box.classList.remove('hidden');
                    document.getElementById('v-entrada').focus();
                } else {
                    box.classList.add('hidden');
                    document.getElementById('v-entrada').value = "0.00";
                }
            });
            carregarDados();
        });

        async function carregarDados() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(API + "?t=" + Date.now());
                const data = await res.json();
                DB = data;
                renderGradeProdutos('');
                renderVendas();
                renderDash();
                renderProdutosLista();
                msgStatus("Sistema Conectado üåô", "success");
            } catch (e) {
                console.error(e);
                msgStatus("Erro de Conex√£o ‚ö†Ô∏è", "error");
            }
            document.getElementById('loading').classList.add('hidden');
        }

        function msgStatus(txt, type) {
            const el = document.getElementById('status-msg');
            el.innerText = txt;
            el.className = type === 'success' 
                ? "text-center p-2 mb-4 text-xs font-bold uppercase rounded-xl bg-green-900/50 border border-green-500 text-green-300 shadow-sm animate-[fadeIn_0.5s]" 
                : "text-center p-2 mb-4 text-xs font-bold uppercase rounded-xl bg-red-900/50 border border-red-500 text-red-300 shadow-sm animate-[fadeIn_0.5s]";
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        function renderGradeProdutos(filtro) {
            const container = document.getElementById('grid-produtos');
            container.innerHTML = DB.produtos.filter(m => m.nome.toLowerCase().includes(filtro.toLowerCase())).map(m => `
                <button onclick="addItem('${m.nome}', ${m.custo}, ${m.venda})" class="p-3 bg-surface border border-gray-700 rounded-xl shadow-md hover:border-primary active:scale-95 transition-all text-left flex justify-between items-center group">
                    <div class="flex flex-col"><span class="font-bold text-xs text-gray-300 uppercase group-hover:text-primary transition">${m.nome}</span><span class="text-[10px] text-gray-500">Estoque</span></div>
                    <div class="text-primary font-bold text-sm bg-gray-900 px-2 py-1 rounded-lg border border-gray-700">R$ ${Number(m.venda).toFixed(2)}</div>
                </button>`).join('');
        }

        function addItem(nome, custo, venda) {
            const existe = pedido.find(p => p.nome === nome);
            if(existe) existe.qtd++; else pedido.push({ nome, custo, venda, qtd: 1 });
            renderCarrinho();
        }

        function renderCarrinho() {
            const container = document.getElementById('lista-pedido');
            const total = pedido.reduce((a,b) => a + (b.venda * b.qtd), 0);
            document.getElementById('itens-count').innerText = pedido.reduce((a,b)=>a+b.qtd,0) + " itens";
            document.getElementById('res-venda').innerText = "R$ " + total.toFixed(2);
            if(pedido.length === 0) { container.innerHTML = '<div class="p-8 text-center text-gray-500 text-sm italic flex flex-col items-center"><i class="fas fa-shopping-basket text-2xl mb-2 opacity-50"></i>Sua sacola est√° vazia</div>'; return; }
            container.innerHTML = pedido.map((p, i) => `
                <div class="p-3 flex justify-between items-center bg-surface hover:bg-gray-700 transition">
                    <div class="flex-1"><div class="font-bold text-xs text-gray-300 uppercase">${p.nome}</div><div class="text-[10px] text-gray-500">Unit: R$ ${Number(p.venda).toFixed(2)}</div></div>
                    <div class="flex items-center gap-3"><div class="text-sm font-bold text-primary">R$ ${(p.venda * p.qtd).toFixed(2)}</div><div class="flex items-center border border-gray-600 rounded-lg bg-gray-800 shadow-sm"><button onclick="alterarQtd(${i}, -1)" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-400 font-bold">-</button><span class="w-6 text-center text-xs font-bold text-white">${p.qtd}</span><button onclick="alterarQtd(${i}, 1)" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-green-400 font-bold">+</button></div><button onclick="removerItem(${i})" class="text-red-900 hover:text-red-500 ml-1"><i class="fas fa-trash-alt"></i></button></div>
                </div>`).join('');
        }

        function alterarQtd(i, d) { pedido[i].qtd += d; if(pedido[i].qtd <= 0) pedido.splice(i, 1); renderCarrinho(); }
        function removerItem(i) { pedido.splice(i, 1); renderCarrinho(); }

        async function registrarVenda() {
            const cli = document.getElementById('v-cliente').value;
            if(!cli || pedido.length === 0) return alert("Por favor, informe o cliente e adicione produtos!");
            document.getElementById('loading').classList.remove('hidden');
            const totalVenda = pedido.reduce((a,b) => a + (b.venda * b.qtd), 0);
            const formaPgto = document.getElementById('v-pgto').value;
            let valorRecebido = totalVenda;
            let status = "Pago";
            if (formaPgto === "A PRAZO") {
                const entrada = parseFloat(document.getElementById('v-entrada').value) || 0;
                valorRecebido = entrada;
                if(entrada >= totalVenda) status = "Pago"; else if(entrada > 0) status = "Parcial"; else status = "Pendente";
            }
            const venda = {
                data: document.getElementById('v-data').value,
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                cliente: cli.toUpperCase(),
                whatsapp: document.getElementById('v-tel').value,
                cpf: document.getElementById('v-cpf').value,
                endereco: "Loja",
                itens: pedido.map(p => `${p.qtd}x ${p.nome}`).join(", "),
                total_custo: pedido.reduce((a,b) => a + (b.custo * b.qtd), 0).toFixed(2),
                total_venda: totalVenda.toFixed(2),
                pagamento: formaPgto,
                status: status,
                valor_recebido: valorRecebido.toFixed(2),
                historico_pagamento: valorRecebido > 0 ? `Entrada: ${valorRecebido.toFixed(2)}` : ""
            };
            await fetch(API, { method: 'POST', body: JSON.stringify({acao: 'salvar_venda', dados: venda}) });
            const audio = document.getElementById("som-venda"); audio.play();
            setTimeout(() => location.reload(), 1000); 
        }

        function setFiltroDash(dias, btn) {
            filtroDashDias = dias;
            document.querySelectorAll('.filt-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderDash();
        }

        function renderDash() {
            const termoProd = document.getElementById('filtro-prod-dash').value.toLowerCase();
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            
            const vendasFiltradas = DB.vendas.filter(v => {
                const temProduto = termoProd === "" || v[6].toLowerCase().includes(termoProd);
                if(!temProduto) return false;
                if(filtroDashDias === 'all') return true;
                
                let dataVenda;
                if(v[1].includes('-')) { const parts = v[1].split('-'); dataVenda = new Date(parts[0], parts[1]-1, parts[2]); } 
                else { const parts = v[1].split('/'); dataVenda = new Date(parts[2], parts[1]-1, parts[0]); }
                dataVenda.setHours(0,0,0,0);
                
                const diffTime = Math.abs(hoje - dataVenda);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                if(filtroDashDias === 0) return diffDays === 0;
                return diffDays <= filtroDashDias;
            });

            const totalVenda = vendasFiltradas.reduce((a,v) => a + parseFloat(String(v[8]).replace(',', '.')), 0);
            const totalCusto = vendasFiltradas.reduce((a,v) => a + parseFloat(String(v[7]).replace(',', '.')), 0);
            
            document.getElementById('dash-faturam').innerText = "R$ " + totalVenda.toFixed(2);
            document.getElementById('dash-custo').innerText = "R$ " + totalCusto.toFixed(2);
            document.getElementById('dash-lucro').innerText = "R$ " + (totalVenda - totalCusto).toFixed(2);
            
            document.getElementById('dash-saidas').innerHTML = vendasFiltradas.slice(-10).reverse().map(v => {
                let dataFormatada = v[1];
                if(v[1].includes('-')) { const parts = v[1].split('-'); dataFormatada = `${parts[2]}/${parts[1]}`; } 
                else if(v[1].length > 5) { dataFormatada = v[1].substring(0,5); }
                return `
                <tr class="border-b border-gray-700 hover:bg-gray-700/50 transition">
                    <td class="py-3 pl-2 text-[10px] text-gray-400 font-bold">${dataFormatada}</td>
                    <td class="py-3 text-xs uppercase text-gray-300"><div class="font-bold">${v[3]}</div><div class="text-[9px] text-gray-500 truncate w-24">${v[6]}</div></td>
                    <td class="py-3 pr-2 text-right text-xs font-bold text-primary">R$ ${parseFloat(String(v[8]).replace(',', '.')).toFixed(0)}</td>
                </tr>`}).join('');
        }

        // --- ABA COBRAN√áA (SEM FILTROS) ---
        function renderVendas(termo = "") {
            const lista = document.getElementById('lista-vendas-container');
            let filtradas = DB.vendas.slice().reverse().filter(v => {
                return v[3].toLowerCase().includes(termo.toLowerCase()) || v[0].includes(termo);
            });

            if(filtradas.length === 0) { lista.innerHTML = '<div class="text-center mt-10 opacity-50 flex flex-col items-center"><i class="fas fa-inbox text-4xl mb-2 text-gray-600"></i><p class="text-sm text-gray-500">Nenhum registro encontrado</p></div>'; return; }

            lista.innerHTML = filtradas.map(v => {
                const id = v[0];
                const total = parseFloat(String(v[8]).replace(',', '.')); 
                const status = v[10].trim();
                const recebido = v[12] ? parseFloat(String(v[12]).replace(',', '.')) : (status === 'Pago' ? total : 0);
                const restante = total - recebido;
                const percentual = Math.min(100, (recebido / total) * 100);
                let borderClass = status === 'Pago' ? 'status-pago' : (status === 'Parcial' ? 'status-parcial' : 'status-pendente');
                return `
                <div class="bg-surface p-4 rounded-2xl shadow-sm border border-gray-700 ${borderClass} mb-3 animate-[fadeIn_0.3s]">
                    <div class="flex justify-between items-start mb-2">
                        <div><h4 class="font-bold text-gray-200 uppercase leading-none text-sm">${v[3]}</h4><span class="text-[10px] text-gray-500 font-bold">${v[1]} ‚Ä¢ #${id}</span></div>
                        <div class="text-right"><div class="text-base font-black text-gray-200">R$ ${total.toFixed(2)}</div><div class="text-[9px] uppercase font-bold text-gray-400 bg-black/20 px-2 rounded border border-gray-600 inline-block">${status}</div></div>
                    </div>
                    <div class="mb-3 bg-black/20 p-2 rounded-lg border border-gray-700">
                        <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-1"><span class="text-green-500">Pago: R$ ${recebido.toFixed(2)}</span><span class="${restante > 0.05 ? 'text-red-400' : 'text-gray-500'}">Falta: R$ ${restante.toFixed(2)}</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-1.5"><div class="bg-primary h-1.5 rounded-full transition-all duration-500" style="width: ${percentual}%"></div></div>
                    </div>
                    <div class="flex gap-2">
                        ${status !== 'Pago' ? `<button onclick="abrirAbatimento('${id}', ${restante}, ${recebido})" class="flex-1 bg-primary text-white py-2 rounded-xl font-bold text-xs uppercase shadow-sm active:scale-95 transition">Receber</button>` : `<div class="flex-1 text-center py-2 text-green-500 font-bold text-xs uppercase bg-green-900/20 rounded-xl border border-green-900/50"><i class="fas fa-check-circle"></i> Quitado</div>`}
                        <button onclick="abrirNota('${id}')" class="w-10 h-10 flex items-center justify-center border border-gray-600 rounded-xl text-gray-400 hover:bg-gray-700 active:scale-95 transition"><i class="fas fa-receipt"></i></button>
                        <button onclick="excluirVenda('${id}')" class="w-10 h-10 flex items-center justify-center border border-red-900/50 text-red-400 hover:bg-red-900/20 hover:text-red-500 rounded-xl active:scale-95 transition"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        function abrirAbatimento(id, restante, jaPago) {
            vParaAbater = { id, restante, jaPago };
            document.getElementById('valor-abatimento').value = "";
            document.getElementById('valor-abatimento').placeholder = "M√°x: " + restante.toFixed(2);
            document.getElementById('modal-pagamento').style.display = 'flex';
            document.getElementById('valor-abatimento').focus();
        }
        function fecharModalPagamento() { document.getElementById('modal-pagamento').style.display = 'none'; vParaAbater = null; }

        async function confirmarAbatimento() {
            if(!vParaAbater) return;
            const valor = parseFloat(document.getElementById('valor-abatimento').value);
            if(!valor || valor <= 0) return alert("Valor inv√°lido!");
            if(valor > vParaAbater.restante + 0.10) return alert("Valor maior que a d√≠vida!");
            document.getElementById('modal-pagamento').style.display = 'none';
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API, { method: 'POST', body: JSON.stringify({acao: 'amortizar_divida', id: vParaAbater.id, valor_pago: valor, novo_total_pago: vParaAbater.jaPago + valor}) });
            carregarDados();
        }

        function renderProdutosLista() {
            document.getElementById('lista-produtos-cards').innerHTML = DB.produtos.map(m => `
                <div class="flex justify-between items-center bg-surface p-3 rounded-xl border border-gray-700 shadow-sm">
                    <div><div class="font-bold text-gray-300 uppercase text-xs">${m.nome}</div><div class="text-[10px] text-gray-500">Custo: R$${Number(m.custo).toFixed(2)} | Venda: <span class="text-primary font-bold">R$${Number(m.venda).toFixed(2)}</span></div></div>
                    <button onclick="excluirProd('${m.nome}')" class="text-red-900 hover:text-red-500 p-2"><i class="fas fa-trash"></i></button>
                </div>`).join('');
        }

        async function adicionarProduto() {
            const n = document.getElementById('p-nome').value; const c = document.getElementById('p-custo').value; const v = document.getElementById('p-venda').value;
            if(!n || !v) return alert("Preencha nome e venda!");
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API, { method: 'POST', body: JSON.stringify({acao: 'salvar_produto', dados: {nome: n.toUpperCase(), custo: c || 0, venda: v}}) });
            location.reload();
        }

        async function excluirProd(n) { if(confirm(`Apagar ${n}?`)) { document.getElementById('loading').classList.remove('hidden'); await fetch(API, { method: 'POST', body: JSON.stringify({acao: 'excluir_produto', nome: n}) }); carregarDados(); }}
        async function excluirVenda(id) { if(confirm("Apagar venda?")) { document.getElementById('loading').classList.remove('hidden'); await fetch(API, { method: 'POST', body: JSON.stringify({acao: 'excluir_venda', id: id}) }); carregarDados(); }}

        function abrirNota(id) {
            const v = DB.vendas.find(x => x[0] == id); if(!v) return;
            document.getElementById('recibo-id').innerText = "#"+v[0]; 
            document.getElementById('p-data').innerText = v[1]; 
            document.getElementById('p-cliente').innerText = v[3];
            
            // CORRE√á√ÉO: TELEFONE
            document.getElementById('p-tel-nota').innerText = v[4] || "";
            if(v[4]) document.getElementById('box-tel-nota').classList.remove('hidden');
            else document.getElementById('box-tel-nota').classList.add('hidden');

            if(v[5] && v[5].length > 4) { document.getElementById('p-cpf-nota').innerText = v[5]; document.getElementById('box-cpf-nota').classList.remove('hidden'); } else { document.getElementById('box-cpf-nota').classList.add('hidden'); }
            document.getElementById('p-itens').innerHTML = v[6].split(', ').map(i => `<div class="flex justify-between text-xs border-b border-gray-300 py-1"><span>${i.split('x ')[1]}</span><span>${i.split('x ')[0]}un</span></div>`).join('');
            const total = parseFloat(String(v[8]).replace(',', '.')); const recebido = v[12] ? parseFloat(String(v[12]).replace(',', '.')) : (v[10] === 'Pago' ? total : 0); const restante = total - recebido;
            document.getElementById('p-total-venda').innerText = "R$ " + total.toFixed(2); document.getElementById('p-valor-pago').innerText = "R$ " + recebido.toFixed(2); document.getElementById('p-valor-restante').innerText = "R$ " + (restante > 0 ? restante.toFixed(2) : "0.00");
            const linhaRestante = document.getElementById('linha-restante'); if(restante > 0.05) linhaRestante.classList.remove('hidden'); else linhaRestante.classList.add('hidden');
            document.getElementById('p-pgto-nota').innerText = v[9]; document.getElementById('p-status').innerText = v[10].toUpperCase(); document.getElementById('modal-nota').style.display = 'flex';
        }
        function fecharNota() { document.getElementById('modal-nota').style.display = 'none'; }
        function enviarZap() {
            const cliente = document.getElementById('p-cliente').innerText; const total = document.getElementById('p-total-venda').innerText; const restante = document.getElementById('p-valor-restante').innerText;
            const texto = `Ol√° *${cliente}*! üíú%0A%0AAqui est√° o comprovante da sua compra na *Neide Variedades*.%0A%0A*Total:* ${total}%0A*Restante a pagar:* ${restante}%0A%0A_Obrigada pela prefer√™ncia!_`;
            window.open(`https://api.whatsapp.com/send?text=${texto}`);
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'text-primary')); document.getElementById('btn-' + id).classList.add('active');
        }
    </script>
</body>
</html>